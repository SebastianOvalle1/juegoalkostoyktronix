<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Battle - Actividad Empresarial</title>
    <style>
        /* Todos tus estilos se mantienen igual */
        :root {
            --primary: #4a6baf;
            --secondary: #ff6b6b;
            --accent: #4ecdc4;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --red: #ff6b6b;
            --blue: #4a6baf;
            --green: #4ecdc4;
            --yellow: #ffd166;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark) 0%, #16213e 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent);
            font-size: 2.5rem;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            margin: 15px 0;
            color: var(--accent);
        }
        
        h3 {
            margin: 15px 0;
            color: var(--light);
            text-align: center;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .input-field {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1rem;
        }
        
        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .team-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .team {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            width: 220px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }
        
        .team:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .team.selected {
            background: var(--primary);
            box-shadow: 0 0 15px rgba(74, 107, 175, 0.5);
        }
        
        .team-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .team-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .team-area {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.2;
            padding: 0 5px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .question-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .answers-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .answers-container {
                grid-template-columns: 1fr;
            }
            
            .team {
                width: 100%;
                max-width: 280px;
            }
        }
        
        .answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .answer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .answer-btn.correct {
            background: #4caf50;
            animation: pulse 0.5s;
        }
        
        .answer-btn.incorrect {
            background: #f44336;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .lives-container {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .life {
            color: var(--secondary);
            font-size: 2rem;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .life.lost {
            animation: loseLife 0.5s forwards;
        }
        
        @keyframes loseLife {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        .scoreboard {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .player-score {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .highlight {
            color: var(--accent);
            font-weight: bold;
        }
        
        .timer {
            font-size: 2rem;
            text-align: center;
            margin: 10px 0;
            color: var(--accent);
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .player-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .team-red { border-left: 4px solid var(--red); }
        .team-blue { border-left: 4px solid var(--blue); }
        .team-green { border-left: 4px solid var(--green); }
        .team-yellow { border-left: 4px solid var(--yellow); }
        
        .team-score {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .team-red-bg { background: rgba(255, 107, 107, 0.2); }
        .team-blue-bg { background: rgba(74, 107, 175, 0.2); }
        .team-green-bg { background: rgba(78, 205, 196, 0.2); }
        .team-yellow-bg { background: rgba(255, 209, 102, 0.2); }
        
        .ranking-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            opacity: 1;
            border-bottom: 3px solid var(--accent);
        }
        
        .ranking-content {
            display: none;
        }
        
        .ranking-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .team-stats {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 Quiz Battle - Yo Puedo - Alkosto/Ktronix 🎯</h1>

        <div id="error-message" class="error-message" style="display: none;">
            <h3>Error de conexión</h3>
            <p id="error-text">No se pudo conectar con el servidor.</p>
            <div class="debug-info" id="debug-info"></div>
            <button id="retry-btn" class="btn">Reintentar conexión</button>
        </div>
        
        <!-- Pantalla de inicio -->
        <div id="welcome-screen" class="screen active">
            <h2>¡Bienvenido al desafío!</h2>
            <p>Responde preguntas, acumula puntos y compite con tus colegas.</p>
            <div style="text-align: center; margin-top: 30px;">
                <button id="start-btn" class="btn">Comenzar Juego</button>
            </div>
        </div>
        
        <!-- Pantalla de registro -->
        <div id="register-screen" class="screen">
            <h2>Únete a la batalla</h2>
            <input type="text" id="player-name" class="input-field" placeholder="Ingresa tu nombre">
            <h3>Elige tu equipo:</h3>
            <div class="team-container">
                <div class="team" data-team="red">
                    <div class="team-icon">🔴</div>
                    <div class="team-name">Equipo Rojo</div>
                    <div class="team-area">CENTR</div>
                </div>
                <div class="team" data-team="blue">
                    <div class="team-icon">🔵</div>
                    <div class="team-name">Equipo Azul</div>
                    <div class="team-area">GESTIÓN DE CASOS</div>
                </div>
                <div class="team" data-team="green">
                    <div class="team-icon">🟢</div>
                    <div class="team-name">Equipo Verde</div>
                    <div class="team-area">ANILLO 2</div>
                </div>
                <div class="team" data-team="yellow">
                    <div class="team-icon">🟡</div>
                    <div class="team-name">Equipo Amarillo</div>
                    <div class="team-area">OTRAS ÁREAS</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="join-btn" class="btn">Unirse al Juego</button>
            </div>
        </div>
        
        <!-- Pantalla de espera -->
        <div id="waiting-screen" class="screen">
            <h2>Esperando a que comience el juego...</h2>
            <p>Jugadores conectados: <span id="players-count">0</span></p>
            <div class="players-grid" id="players-list">
                <!-- Jugadores en tiempo real -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="start-game-btn" class="btn">Iniciar Juego</button>
            </div>
        </div>
        
        <!-- Pantalla de juego -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div>Jugador: <span id="current-player" class="highlight">Nombre</span></div>
                <div>Puntos: <span id="current-score" class="highlight">0</span></div>
                <div>Vidas: <span id="current-lives" class="highlight">3</span></div>
            </div>
            
            <div class="question-container">
                <h2 id="question-text">¿Cuál es la capital de Francia?</h2>
            </div>
            
            <div class="timer" id="timer">30</div>
            
            <div class="answers-container">
                <button class="answer-btn" data-correct="false">Londres</button>
                <button class="answer-btn" data-correct="false">Berlín</button>
                <button class="answer-btn" data-correct="true">París</button>
                <button class="answer-btn" data-correct="false">Madrid</button>
            </div>
            
            <div class="lives-container">
                <span class="life">❤️</span>
                <span class="life">❤️</span>
                <span class="life">❤️</span>
            </div>
        </div>
        
        <!-- Pantalla de puntuaciones -->
        <div id="scores-screen" class="screen">
            <h2>Puntuaciones Finales</h2>
            
            <div class="ranking-tabs">
                <div class="tab active" data-tab="players">Ranking Individual</div>
                <div class="tab" data-tab="teams">Ranking por Equipos</div>
            </div>
            
            <div id="players-ranking" class="ranking-content active">
                <div class="scoreboard" id="scoreboard">
                    <!-- Los scores individuales se generarán dinámicamente -->
                </div>
            </div>
            
            <div id="teams-ranking" class="ranking-content">
                <div class="scoreboard" id="teams-scoreboard">
                    <!-- Los scores de equipos se generarán dinámicamente -->
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="play-again-btn" class="btn">Jugar de Nuevo</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    
    <script>
       // Configuración de PocketBase
const POCKETBASE_URL = 'https://was-pink.pockethost.io/';
let pb = new PocketBase(POCKETBASE_URL);

// DESACTIVAR AUTOCANCELACIÓN GLOBALMENTE - ESTO ES CLAVE
pb.autoCancellation(false);

// Estado del juego
let players = [];
let currentPlayer = null;
let currentQuestionIndex = 0;
let score = 0;
let lives = 3;
let timer;
let timeLeft = 30;
let lifeElements = [];
let gameId = null;
let realtimeSubscription = null;
let isOnline = true;

// Obtener referencias a elementos DOM
const startBtn = document.getElementById('start-btn');
const joinBtn = document.getElementById('join-btn');
const startGameBtn = document.getElementById('start-game-btn');
const playAgainBtn = document.getElementById('play-again-btn');
const retryBtn = document.getElementById('retry-btn');
const playerNameInput = document.getElementById('player-name');
const playersCount = document.getElementById('players-count');
const playersList = document.getElementById('players-list');
const currentPlayerElement = document.getElementById('current-player');
const currentScoreElement = document.getElementById('current-score');
const currentLivesElement = document.getElementById('current-lives');
const questionText = document.getElementById('question-text');
const timerElement = document.getElementById('timer');
const answersContainer = document.querySelector('.answers-container');
const scoreboard = document.getElementById('scoreboard');
const teamsScoreboard = document.getElementById('teams-scoreboard');
const errorMessage = document.getElementById('error-message');
const errorText = document.getElementById('error-text');
const debugInfo = document.getElementById('debug-info');

// Obtener todas las pantallas y equipos
const screens = document.querySelectorAll('.screen');
const teamElements = document.querySelectorAll('.team');
const tabs = document.querySelectorAll('.tab');
const rankingContents = document.querySelectorAll('.ranking-content');
        
        // Funciones de API directas con fetch para evitar autocancelación
async function pbFetch(collection, options = {}) {
    const { method = 'GET', id = '', data = null, filter = '' } = options;
    const url = id 
        ? `${POCKETBASE_URL}api/collections/${collection}/records/${id}`
        : `${POCKETBASE_URL}api/collections/${collection}/records`;
    
    const params = new URLSearchParams();
    if (filter) params.append('filter', filter);
    
    const fullUrl = params.toString() ? `${url}?${params.toString()}` : url;
    
    const config = {
        method,
        headers: {
            'Content-Type': 'application/json',
        },
    };
    
    if (data && method !== 'GET') {
        config.body = JSON.stringify(data);
    }
    
    try {
        const response = await fetch(fullUrl, config);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        console.error(`Error en pbFetch ${collection}:`, error);
        throw error;
    }
}

// Versiones específicas para evitar autocancelación
async function pbCreate(collection, data) {
    return pbFetch(collection, { method: 'POST', data });
}

async function pbUpdate(collection, id, data) {
    return pbFetch(collection, { method: 'PATCH', id, data });
}

async function pbGetOne(collection, id) {
    return pbFetch(collection, { method: 'GET', id });
}

async function pbGetList(collection, filter = '') {
    return pbFetch(collection, { method: 'GET', filter });
}

        // Preguntas
        const questions = [
            {
                question: "¿Cuál es la capital de Francia?",
                answers: [
                    { text: "Londres", correct: false },
                    { text: "Berlín", correct: false },
                    { text: "París", correct: true },
                    { text: "Madrid", correct: false }
                ]
            },
            {
                question: "¿En qué año llegó el hombre a la luna?",
                answers: [
                    { text: "1965", correct: false },
                    { text: "1969", correct: true },
                    { text: "1972", correct: false },
                    { text: "1958", correct: false }
                ]
            },
            {
                question: "¿Cuál es el río más largo del mundo?",
                answers: [
                    { text: "Nilo", correct: true },
                    { text: "Amazonas", correct: false },
                    { text: "Misisipi", correct: false },
                    { text: "Yangtsé", correct: false }
                ]
            },
            {
                question: "¿Qué elemento químico tiene el símbolo 'Au'?",
                answers: [
                    { text: "Plata", correct: false },
                    { text: "Arsénico", correct: false },
                    { text: "Oro", correct: true },
                    { text: "Aluminio", correct: false }
                ]
            },
            {
                question: "¿Quién pintó la Mona Lisa?",
                answers: [
                    { text: "Vincent van Gogh", correct: false },
                    { text: "Pablo Picasso", correct: false },
                    { text: "Leonardo da Vinci", correct: true },
                    { text: "Michelangelo", correct: false }
                ]
            },
            // NUEVAS PREGUNTAS A PARTIR DE AQUÍ
            {
                question: "¿Cuál es el metal líquido a temperatura ambiente?",
                answers: [
                    { text: "Mercurio", correct: true },
                    { text: "Plomo", correct: false },
                    { text: "Aluminio", correct: false },
                    { text: "Cobre", correct: false }
                ]
            },
            {
                question: "¿Qué superhéroe tiene el alter ego de Peter Parker?",
                answers: [
                    { text: "Iron Man", correct: false },
                    { text: "Spider-Man", correct: true },
                    { text: "Batman", correct: false },
                    { text: "Superman", correct: false }
                ]
            },
            {
                question: "¿Qué planeta es conocido como 'el planeta rojo'?",
                answers: [
                    { text: "Venus", correct: false },
                    { text: "Júpiter", correct: false },
                    { text: "Marte", correct: true },
                    { text: "Saturno", correct: false }
                ]
            },
            {
                question: "¿Qué banda británica fue liderada por Freddie Mercury?",
                answers: [
                    { text: "The Beatles", correct: false },
                    { text: "Queen", correct: true },
                    { text: "Rolling Stones", correct: false },
                    { text: "Led Zeppelin", correct: false }
                ]
            },
            {
                question: "¿En qué año se estrenó la película 'Avengers: Endgame'?",
                answers: [
                    { text: "2018", correct: false },
                    { text: "2019", correct: true },
                    { text: "2020", correct: false },
                    { text: "2017", correct: false }
                ]
            },
            {
                question: "¿Cuál es el océano más grande del mundo?",
                answers: [
                    { text: "Atlántico", correct: false },
                    { text: "Índico", correct: false },
                    { text: "Pacífico", correct: true },
                    { text: "Ártico", correct: false }
                ]
            },
            {
                question: "¿Qué metal es el principal componente del núcleo de la Tierra?",
                answers: [
                    { text: "Oro", correct: false },
                    { text: "Hierro", correct: true },
                    { text: "Plata", correct: false },
                    { text: "Cobre", correct: false }
                ]
            },
            {
                question: "¿Qué actor interpreta a Iron Man en el Universo Cinematográfico de Marvel?",
                answers: [
                    { text: "Chris Evans", correct: false },
                    { text: "Chris Hemsworth", correct: false },
                    { text: "Robert Downey Jr.", correct: true },
                    { text: "Mark Ruffalo", correct: false }
                ]
            },
            {
                question: "¿Qué cantante es conocida como 'La Reina del Pop'?",
                answers: [
                    { text: "Beyoncé", correct: false },
                    { text: "Madonna", correct: true },
                    { text: "Lady Gaga", correct: false },
                    { text: "Rihanna", correct: false }
                ]
            },
            {
                question: "¿Cuál es el animal más grande del mundo?",
                answers: [
                    { text: "Elefante africano", correct: false },
                    { text: "Ballena azul", correct: true },
                    { text: "Tiburón ballena", correct: false },
                    { text: "Jirafa", correct: false }
                ]
            },
            {
                question: "¿Qué planeta tiene anillos visiblemente prominentes?",
                answers: [
                    { text: "Júpiter", correct: false },
                    { text: "Saturno", correct: true },
                    { text: "Urano", correct: false },
                    { text: "Neptuno", correct: false }
                ]
            },
            {
                question: "¿Qué superhéroe proviene del planeta Krypton?",
                answers: [
                    { text: "Batman", correct: false },
                    { text: "Flash", correct: false },
                    { text: "Superman", correct: true },
                    { text: "Green Lantern", correct: false }
                ]
            },
            {
                question: "¿Qué grupo musical lanzó el álbum 'The Dark Side of the Moon'?",
                answers: [
                    { text: "The Beatles", correct: false },
                    { text: "Led Zeppelin", correct: false },
                    { text: "Pink Floyd", correct: true },
                    { text: "Queen", correct: false }
                ]
            },
            {
                question: "¿Cuál es el país más grande del mundo por área territorial?",
                answers: [
                    { text: "Canadá", correct: false },
                    { text: "China", correct: false },
                    { text: "Estados Unidos", correct: false },
                    { text: "Rusia", correct: true }
                ]
            },
            {
                question: "¿Qué villano es el archienemigo de Spider-Man?",
                answers: [
                    { text: "Duende Verde", correct: true },
                    { text: "Joker", correct: false },
                    { text: "Lex Luthor", correct: false },
                    { text: "Magneto", correct: false }
                ]
            },
            {
                question: "¿Qué instrumento musical asocias con Louis Armstrong?",
                answers: [
                    { text: "Saxofón", correct: false },
                    { text: "Piano", correct: false },
                    { text: "Trompeta", correct: true },
                    { text: "Batería", correct: false }
                ]
            },
            {
                question: "¿En qué continente se encuentra Egipto?",
                answers: [
                    { text: "Asia", correct: false },
                    { text: "África", correct: true },
                    { text: "Europa", correct: false },
                    { text: "América", correct: false }
                ]
            },
            {
                question: "¿Qué metal precioso tiene el símbolo químico 'Ag'?",
                answers: [
                    { text: "Oro", correct: false },
                    { text: "Plata", correct: true },
                    { text: "Platino", correct: false },
                    { text: "Cobre", correct: false }
                ]
            },
            {
                question: "¿Qué actor interpreta a Wolverine en las películas de X-Men?",
                answers: [
                    { text: "Hugh Jackman", correct: true },
                    { text: "Ryan Reynolds", correct: false },
                    { text: "Patrick Stewart", correct: false },
                    { text: "Ian McKellen", correct: false }
                ]
            },
            {
                question: "¿Qué banda canadiense es conocida por éxitos como 'The Spirit of Radio'?",
                answers: [
                    { text: "Nickelback", correct: false },
                    { text: "Rush", correct: true },
                    { text: "Barenaked Ladies", correct: false },
                    { text: "Arcade Fire", correct: false }
                ]
            }
        ];

        // Event Listeners - VERSIÓN MEJORADA
startBtn.addEventListener('click', () => {
    showScreen('register-screen');
    // Pequeño delay para que la UI se actualice antes de init
    setTimeout(initGame, 100);
});

joinBtn.addEventListener('click', registerPlayer);
startGameBtn.addEventListener('click', () => {
console.log("🟢 Botón de iniciar juego clickeado");
    console.log("Current Player:", currentPlayer);
    console.log("Players:", players);
    console.log("Game ID:", gameId);

    // Pequeño delay para evitar autocancelación
    setTimeout(startGame, 100);
});
playAgainBtn.addEventListener('click', () => window.location.reload());
retryBtn.addEventListener('click', initGame);

        // Tabs para ranking
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                rankingContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-ranking`) {
                        content.classList.add('active');
                    }
                });
            });
        });

// Función de delay para evitar conflictos
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

        // Función para mostrar errores
        function showError(message, details = '') {
            console.error("Error:", message, details);
            errorText.textContent = message;
            debugInfo.textContent = details || 'No hay detalles adicionales';
            errorMessage.style.display = 'block';
            isOnline = false;
        }

        // Función para ocultar errores
        function hideError() {
            errorMessage.style.display = 'none';
            isOnline = true;
        }

        // Verificar conexión
        async function checkConnection() {
            try {
                // Intentar una solicitud simple a PocketBase
                await pb.collection('users').getList(1, 1);
                return true;
            } catch (error) {
                showError(
                    "No se puede conectar con el servidor", 
                    `Error: ${error.message || 'Desconocido'}`
                );
                return false;
            }
        }

// Inicializar el juego - USANDO FETCH DIRECTAMENTE
async function initGame() {
    hideError();
    
    try {
        // Inicializar elementos de vida
        lifeElements = document.querySelectorAll('.life');
        
        // Buscar juegos existentes usando fetch directo
        const existingGames = await pbGetList('games', 'status = "waiting"');
        
        if (existingGames.items && existingGames.items.length > 0) {
            gameId = existingGames.items[0].id;
            console.log("Uniéndose a juego existente:", gameId);
            
            // Obtener el estado actual del juego
            const game = await pbGetOne('games', gameId);
            
            // Verificar estado inmediatamente
            if (game.status === "started") {
                console.log("Juego ya iniciado, uniéndose directamente");
                await updatePlayersList();
                startGameForAllPlayers();
                return;
            }
            
            // Obtener jugadores existentes
            await updatePlayersList();
        } else {
            console.log("Creando nuevo juego");
            const game = await pbCreate('games', {
                code: Math.floor(1000 + Math.random() * 9000).toString(),
                status: "waiting",
                players_count: 0,
                current_question: 0
            });
            gameId = game.id;
            console.log("Nuevo juego creado:", gameId);
        }
        
        // Suscribirse a cambios en tiempo real (solo suscripción usa SDK)
        await subscribeToRealtime();
        
    } catch (error) {
        console.error("Error inicializando juego:", error);
        showError("Error inicializando el juego", error.message);
    }
}

// Suscribirse a cambios en tiempo real - VERSIÓN MEJORADA
async function subscribeToRealtime() {
    try {
        console.log("Intentando suscribirse a tiempo real, gameId:", gameId);
        
        if (!gameId) {
            console.error("No hay gameId para suscribirse");
            // Intentar obtener gameId nuevamente después de un breve delay
            setTimeout(subscribeToRealtime, 2000);
            return;
        }

        // Desuscribirse si ya hay una suscripción
        if (realtimeSubscription) {
            try { 
                console.log("Desuscribiendo suscripción existente");
                await realtimeSubscription.unsubscribe(); 
            } catch(e){ 
                console.log("Error al desuscribirse:", e);
            }
        }

        // Suscribirse a cambios en el juego específico
        realtimeSubscription = await pb.collection('games').subscribe(gameId, async (e) => {
            console.log("📢 Evento de juego recibido:", e.action, "Estado:", e.record?.status);
            
            if (e.action === 'update' && e.record) {
                const gameData = e.record;
                
                // Actualizar contador de jugadores
                if (gameData.players_count !== undefined) {
                    playersCount.textContent = gameData.players_count;
                }
                
                // Si el juego comenzó, todos los jugadores deben cambiar de pantalla
                if (gameData.status === "started") {
                    console.log("🚀 Juego iniciado - Cambiando a pantalla de juego");
                    // Pequeño delay para asegurar que todo esté listo
                    setTimeout(() => {
                        if (document.getElementById('waiting-screen').classList.contains('active') || 
                            document.getElementById('register-screen').classList.contains('active')) {
                            startGameForAllPlayers();
                        }
                    }, 300);
                }
                
                // Si el juego terminó
                if (gameData.status === "finished") {
                    console.log("🎯 Juego terminado");
                    if (document.getElementById('game-screen').classList.contains('active')) {
                        endGame();
                    }
                }
            }
        });

        console.log("✅ Suscripción a juego activada");

        // Suscribirse a cambios en jugadores de este juego
        await pb.collection('players').subscribe(`game = "${gameId}"`, async (e) => {
            console.log("👤 Evento de jugador:", e.action);
            await updatePlayersList();
        });

    } catch (error) {
        console.error("❌ Error en suscripción en tiempo real:", error);
        
        // Reintentar suscripción después de 3 segundos
        setTimeout(() => {
            subscribeToRealtime();
        }, 3000);
    }
}

        // Selección de equipo
        teamElements.forEach(team => {
            team.addEventListener('click', () => {
                teamElements.forEach(t => t.classList.remove('selected'));
                team.classList.add('selected');
            });
        });

// Registrar jugador - USANDO FETCH DIRECTAMENTE
async function registerPlayer() {
    if (!isOnline) {
        showError("No hay conexión", "Por favor, revisa tu conexión e intenta nuevamente.");
        return;
    }

    const name = playerNameInput.value.trim();
    const selectedTeam = document.querySelector('.team.selected');
    
    if (!name) { alert('Por favor ingresa tu nombre'); return; }
    if (!selectedTeam) { alert('Por favor selecciona un equipo'); return; }
    if (!gameId) { showError("Error", "gameId no definido."); return; }

    try {
        // 1) Crear el player usando fetch directo
        const player = await pbCreate('players', {
            name,
            team: selectedTeam.dataset.team,
            score: 0,
            lives: 3,
            game: gameId,
            connected: true
        });

        // 2) Actualizar currentPlayer localmente
        currentPlayer = {
            id: player.id,
            name,
            team: selectedTeam.dataset.team,
            score: 0,
            lives: 3,
            connected: true
        };

        // 3) Recalcular players_count
        const playersListData = await pbGetList('players', `game = "${gameId}" && connected = true`);
        const realCount = playersListData.items ? playersListData.items.length : 0;
        
        await pbUpdate('games', gameId, { players_count: realCount });

        // 4) VERIFICAR ESTADO DEL JUEGO AL UNIRSE
        try {
            const game = await pbGetOne('games', gameId);
            if (game.status === "started") {
                console.log("Juego ya iniciado - uniéndose directamente");
                startGameForAllPlayers();
            } else {
                showScreen('waiting-screen');
                await updatePlayersList();
            }
        } catch (error) {
            console.error("Error verificando estado del juego:", error);
            showScreen('waiting-screen');
            await updatePlayersList();
        }

    } catch (error) {
        showError("Error registrando jugador", error.message);
    }
}

 // Actualizar lista de jugadores - USANDO FETCH DIRECTAMENTE
async function updatePlayersList() {
    try {
        if (!gameId) return;

        // Traer jugadores actuales del juego usando fetch directo
        const playersListData = await pbGetList('players', `game = "${gameId}" && connected = true`);
        
        players = playersListData.items || [];
        playersCount.textContent = players.length;

        // Render players
        playersList.innerHTML = '';
        players.forEach(player => {
            const playerElement = document.createElement('div');
            playerElement.classList.add('player-card', `team-${player.team}`);
            playerElement.innerHTML = `
                <div><strong>${player.name}</strong></div>
                <div>Equipo ${player.team}</div>
            `;
            playersList.appendChild(playerElement);
        });

        // Mostrar/ocultar botón de inicio para el primer jugador
        if (players.length > 0 && currentPlayer) {
            const sortedPlayers = [...players].sort((a, b) => new Date(a.created) - new Date(b.created));
            const firstPlayer = sortedPlayers[0];
            startGameBtn.style.display = (firstPlayer && currentPlayer.id === firstPlayer.id) ? 'block' : 'none';
        } else {
            startGameBtn.style.display = 'none';
        }

    } catch (error) {
        console.error("Error actualizando lista de jugadores:", error);
    }
}

// Iniciar juego - USANDO FETCH DIRECTAMENTE
async function startGame() {
    try {
        console.log("🔧 Intentando iniciar juego...");
        
        // Solo el primer jugador puede iniciar el juego
        const sortedPlayers = [...players].sort((a, b) => new Date(a.created) - new Date(b.created));
        const firstPlayer = sortedPlayers[0];

        if (!currentPlayer || !firstPlayer) {
            console.error("No hay jugadores o currentPlayer");
            return;
        }

        if (currentPlayer.id !== firstPlayer.id) {
            console.log("No es el primer jugador, no puede iniciar");
            return;
        }

        console.log("🎮 Host iniciando juego...");
        
        // Usar fetch directo para evitar autocancelación
        await pbUpdate('games', gameId, {
            status: "started",
            started_at: new Date().toISOString(),
            current_question: 0
        });

        console.log("✅ Estado del juego actualizado a 'started'");
        
        // El host también necesita cambiar de pantalla
        startGameForAllPlayers();

    } catch (error) {
        console.error("❌ Error iniciando juego:", error);
        showError("Error iniciando juego", error.message);
    }
}

// Función para generar una clave única para las solicitudes
function generateUniqueRequestKey(prefix) {
    return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

// Función para que todos los jugadores inicien el juego - VERSIÓN MEJORADA
async function startGameForAllPlayers() {
    try {
        console.log("🌐 Iniciando juego para todos los jugadores...");
        
        // Verificar que no estamos ya en game-screen
        if (document.getElementById('game-screen').classList.contains('active')) {
            console.log("Ya está en pantalla de juego, ignorando");
            return;
        }
        
        console.log("🔄 Cambiando a pantalla de juego");
        showScreen('game-screen');
        
        // Pequeña pausa para que la UI se actualice
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Obtener el estado actual del juego usando fetch directo
        const game = await pbGetOne('games', gameId);
        
        currentQuestionIndex = game.current_question || 0;
        console.log("📝 Cargando pregunta:", currentQuestionIndex);
        
        await loadQuestion();
        startTimer();
        
    } catch (error) {
        console.error("❌ Error en startGameForAllPlayers:", error);
        
        // Reintentar después de 1 segundo
        setTimeout(() => {
            startGameForAllPlayers();
        }, 1000);
    }
}

// Cargar pregunta
async function loadQuestion() {
    try {
        // Obtener el estado actual del juego usando fetch directo
        const game = await pbGetOne('games', gameId);
        
        currentQuestionIndex = game.current_question || 0;
        
        if (currentQuestionIndex >= questions.length) {
            endGame();
            return;
        }
        
        const question = questions[currentQuestionIndex];
        questionText.textContent = question.question;
        
        answersContainer.innerHTML = '';
        question.answers.forEach(answer => {
            const button = document.createElement('button');
            button.classList.add('answer-btn');
            button.textContent = answer.text;
            button.dataset.correct = answer.correct;
            button.addEventListener('click', selectAnswer);
            answersContainer.appendChild(button);
        });
        
        currentPlayerElement.textContent = currentPlayer.name;
        currentScoreElement.textContent = currentPlayer.score;
        currentLivesElement.textContent = currentPlayer.lives;
        
        // Reiniciar temporizador
        timeLeft = 30;
        timerElement.textContent = timeLeft;
    } catch (error) {
        console.error("Error cargando pregunta:", error);
    }
}

   // Seleccionar respuesta
async function selectAnswer(e) {
    clearInterval(timer);
    const selectedButton = e.target;
    const correct = selectedButton.dataset.correct === 'true';
    
    if (correct) {
        selectedButton.classList.add('correct');
        currentPlayer.score += 10;
        currentScoreElement.textContent = currentPlayer.score;
    } else {
        selectedButton.classList.add('incorrect');
        currentPlayer.lives--;
        currentLivesElement.textContent = currentPlayer.lives;
        
        // Efecto de perder vida
        loseLife();
        
        // Mostrar la respuesta correcta
        document.querySelectorAll('.answer-btn').forEach(button => {
            if (button.dataset.correct === 'true') {
                button.classList.add('correct');
            }
        });
        
        if (currentPlayer.lives <= 0) {
            setTimeout(() => {
                endGame();
            }, 1500);
            return;
        }
    }
    
// Actualizar jugador usando fetch directo
    try {
        await pbUpdate('players', currentPlayer.id, {
            score: currentPlayer.score,
            lives: currentPlayer.lives
        });
        
        // Avanzar a la siguiente pregunta para todos
        const nextQuestionIndex = currentQuestionIndex + 1;
        await pbUpdate('games', gameId, {
            current_question: nextQuestionIndex
        });
        
        setTimeout(() => {
            loadQuestion();
            startTimer();
        }, 1500);
    } catch (error) {
        console.error("Error actualizando jugador:", error);
    }
}
        // Efecto al perder una vida
        function loseLife() {
            const remainingLives = currentPlayer.lives;
            if (lifeElements.length > remainingLives) {
                const lifeToLose = lifeElements[remainingLives];
                lifeToLose.classList.add('lost');
                
                setTimeout(() => {
                    lifeToLose.style.display = 'none';
                }, 500);
            }
        }

        // Iniciar temporizador
        function startTimer() {
            clearInterval(timer);
            timeLeft = 30;
            timerElement.textContent = timeLeft;
            
            timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    currentPlayer.lives--;
                    currentLivesElement.textContent = currentPlayer.lives;
                    
                    loseLife();
                    
                    if (currentPlayer.lives <= 0) {
                        endGame();
                    } else {
                        currentQuestionIndex++;
                        loadQuestion();
                        startTimer();
                    }
                }
            }, 1000);
        }

        // Finalizar juego
        async function endGame() {
            try {
                // Actualizar estado del juego
                await pb.collection('games').update(gameId, {
                    status: "finished",
                    finished_at: new Date()
                });
                
                // Obtener todos los jugadores
                const allPlayers = await pb.collection('players').getFullList({
                    filter: `game = "${gameId}"`
                });
                
                players = allPlayers;
                
                showScreen('scores-screen');
                
                // Calcular puntuaciones por equipos
                const teamScores = {
                    red: { totalScore: 0, playerCount: 0, average: 0, players: [], icon: "🔴" },
                    blue: { totalScore: 0, playerCount: 0, average: 0, players: [], icon: "🔵" },
                    green: { totalScore: 0, playerCount: 0, average: 0, players: [], icon: "🟢" },
                    yellow: { totalScore: 0, playerCount: 0, average: 0, players: [], icon: "🟡" }
                };
                
                // Ordenar jugadores por puntuación
                players.sort((a, b) => b.score - a.score);
                
                // Calcular totales por equipo
                players.forEach(player => {
                    if (teamScores[player.team]) {
                        teamScores[player.team].totalScore += player.score;
                        teamScores[player.team].playerCount++;
                        teamScores[player.team].players.push(player);
                    }
                });
                
                // Calcular promedios
                for (const team in teamScores) {
                    if (teamScores[team].playerCount > 0) {
                        teamScores[team].average = Math.round(teamScores[team].totalScore / teamScores[team].playerCount);
                    }
                }
                
                // Convertir a array y ordenar equipos por promedio
                const sortedTeams = Object.entries(teamScores)
                    .map(([name, data]) => ({ name, ...data }))
                    .sort((a, b) => b.average - a.average);
                
                // Generar tabla de puntuaciones individuales
                scoreboard.innerHTML = '';
                players.forEach((player, index) => {
                    const playerElement = document.createElement('div');
                    playerElement.classList.add('player-score');
                    if (currentPlayer && player.id === currentPlayer.id) {
    playerElement.classList.add('highlight');
}
                    playerElement.innerHTML = `
                        <span>${index + 1}. ${player.name} <small>(Equipo ${player.team})</small></span>
                        <span>${player.score} puntos</span>
                    `;
                    scoreboard.appendChild(playerElement);
                });
                
                // Generar tabla de puntuaciones por equipos
                teamsScoreboard.innerHTML = '';
                sortedTeams.forEach((team, index) => {
                    const teamElement = document.createElement('div');
                    const teamClass = `team-${team.name.replace(/\s+/g, '-').toLowerCase()}-bg`;
teamElement.classList.add('team-score', teamClass);
                    teamElement.innerHTML = `
                        <div>
                            <span class="team-icon">${team.icon}</span>
                            <span>Equipo ${team.name}</span>
                            <div class="team-stats">Promedio: ${team.average} pts (${team.playerCount} jugadores)</div>
                        </div>
                        <div><strong>${team.average}</strong> pts promedio</div>
                    `;
                    teamsScoreboard.appendChild(teamElement);
                    
                    // Agregar jugadores del equipo
                    team.players.sort((a, b) => b.score - a.score).forEach(player => {
                        const playerElement = document.createElement('div');
                        playerElement.classList.add('player-score');
                        playerElement.innerHTML = `
                            <span>${player.name}</span>
                            <span>${player.score} puntos</span>
                        `;
                        teamsScoreboard.appendChild(playerElement);
                    });
                });
            } catch (error) {
                console.error("Error finalizando juego:", error);
            }
        }

        // Mostrar pantalla específica
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Iniciar el juego cuando se carga la página
        window.addEventListener('load', initGame);
        
        window.addEventListener('beforeunload', () => {
    // Desuscribirse localmente (no await)
    try { if (realtimeSubscription && typeof realtimeSubscription.unsubscribe === 'function') realtimeSubscription.unsubscribe(); } catch(e){}

    // Intentar marcar desconexión con sendBeacon (sin bloquear)
    if (currentPlayer && currentPlayer.id) {
        try {
            const url = `${POCKETBASE_URL}api/collections/players/records/${currentPlayer.id}`;
            const body = JSON.stringify({ connected: false });
            // Usa sendBeacon a un endpoint intermedio que acepte PATCH/PUT no siempre es posible.
            // Alternativa: guardar en localStorage para limpiar después o confiar en timeout del servidor.
            // Aquí intentaremos un POST/PUT por fetch (no garantizado en beforeunload).
            navigator.sendBeacon(url, body);
        } catch (err) {
            // fallback silencioso
        }
    }
});


        // Verificar conexión periódicamente
        setInterval(async () => {
            if (!isOnline) {
                const connected = await checkConnection();
                if (connected) {
                    hideError();
                    // Reconectar suscripciones si es necesario
                    if (gameId) {
                        subscribeToRealtime();
                    }
                }
            }
        }, 10000); // Verificar cada 10 segundos

// Al final de tu script, agrega esto:
setInterval(async () => {
    // Verificar si la suscripción está activa
    if (gameId && (!realtimeSubscription || realtimeSubscription.closed)) {
        console.log("Reconectando suscripción...");
        try {
            await subscribeToRealtime();
        } catch (error) {
            console.error("Error reconectando suscripción:", error);
        }
    }
}, 10000); // Verificar cada 10 segundos

    </script>
</body>
</html>